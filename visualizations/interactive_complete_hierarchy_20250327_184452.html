<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 Diagnostic Code Hierarchy</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            overflow-x: hidden;
        }
        #container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
        }
        #visualization {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #controls {
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #infoPanel {
            margin-top: 20px;
            min-height: 100px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .breadcrumbs {
            margin-bottom: 15px;
            padding: 10px 0;
            font-size: 14px;
        }
        .breadcrumb-item {
            display: inline-block;
            padding: 4px 8px;
            margin-right: 5px;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }
        .breadcrumb-item:hover {
            background-color: #e0e0e0;
        }
        .breadcrumb-divider {
            margin: 0 5px;
            color: #999;
        }
        h1 {
            color: #333;
        }
        .node {
            cursor: pointer;
        }
        .node:hover {
            opacity: 0.8;
        }
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            font: 12px sans-serif;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .code-details {
            margin-top: 10px;
        }
        .code-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .code-value {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .code-description {
            margin-top: 10px;
        }
        .search-container {
            margin-bottom: 15px;
        }
        #searchInput {
            padding: 8px 12px;
            width: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #searchButton {
            padding: 8px 16px;
            background-color: #4285f4;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }
        #searchButton:hover {
            background-color: #3367d6;
        }
        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 5px;
            display: none;
        }
        .search-result-item {
            padding: 5px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        .no-results {
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>ICD-10 Diagnostic Code Hierarchy</h1>
        
        <div id="controls">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search for a diagnosis code...">
                <button id="searchButton">Search</button>
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <div class="breadcrumbs" id="breadcrumbs">
                <span class="breadcrumb-item" data-id="root">Root</span>
            </div>
        </div>
        
        <div id="visualization"></div>
        
        <div id="infoPanel">
            <h3>Code Information</h3>
            <p>Click on a section in the visualization to see details about that code.</p>
        </div>
    </div>

    <script>
    // Parse the data from the embedded JSON
    const data = {"id": "ICD-10", "name": "Den internasjonale statistiske klassifikasjonen av sykdommer og beslektede helseproblemer", "value": 1, "children": [{"id": "I", "name": "(A00-B99) Visse infeksjonssykdommer og parasittsykdommer", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "II", "name": "(C00-D48) Svulster", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "III", "name": "(D50-D89) Sykdommer i blod og bloddannende organer og visse tilstander som ang\u00e5r immunsystemet", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "IV", "name": "(E00-E90) Endokrine sykdommer, ern\u00e6ringssykdommer og metabolske forstyrrelser", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "V", "name": "(F00-F99) Psykiske lidelser og atferdsforstyrrelser", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "VI", "name": "(G00-G99) Sykdommer i nervesystemet", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "VII", "name": "(H00-H59) Sykdommer i \u00f8yet og \u00f8yets omgivelser", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "VIII", "name": "(H60-H95) Sykdommer i \u00f8re og \u00f8rebensknute (processus mastoideus)", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "IX", "name": "(I00-I99) Sykdommer i sirkulasjonssystemet", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "X", "name": "(J00-J99) Sykdommer i \u00e5ndedrettssystemet", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XI", "name": "(K00-K93) Sykdommer i ford\u00f8yelsessystemet", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XII", "name": "(L00-L99) Sykdommer i hud og underhud", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XIII", "name": "(M00-M99) Sykdommer i muskel-skjelettsystemet og bindevev", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XIV", "name": "(N00-N99) Sykdommer i urin- og kj\u00f8nnsorganer", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XV", "name": "(O00-O99) Svangerskap, f\u00f8dsel og barseltid", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XVI", "name": "(P00-P96) Visse tilstander som oppst\u00e5r i perinatalperioden", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XVII", "name": "(Q00-Q99) Medf\u00f8dte misdannelser, deformiteter og kromosomavvik", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XVIII", "name": "(R00-R99) Symptomer, tegn, unormale kliniske funn og laboratoriefunn, ikke klassifisert annet sted", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XIX", "name": "(S00-T98) Skader, forgiftninger og visse andre konsekvenser av ytre \u00e5rsaker", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XX", "name": "(V0n-Y98) Ytre \u00e5rsaker til sykdommer, skader og d\u00f8dsfall", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XXI", "name": "(Z00-Z99) Faktorer som har betydning for helsetilstand og kontakt med helsetjenesten", "value": 1, "children": [], "parent": "ICD-10"}, {"id": "XXII", "name": "Koder for spesielle form\u00e5l (U00-U85)", "value": 1, "children": [], "parent": "ICD-10"}]};
    
    // Set up dimensions for the visualization
    const width = document.getElementById('visualization').offsetWidth;
    const height = 600;
    const radius = Math.min(width, height) / 2;
    
    // Create the SVG container
    const svg = d3.select("#visualization")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2}, ${height / 2})`);
    
    // Create tooltip
    const tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
    
    // Create a color scale (adjust for different categories)
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    
    // Create the partition layout
    const partition = d3.partition()
        .size([2 * Math.PI, radius]);
    
    // Create the arc generator
    const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1);
    
    // Create the hierarchy from the data
    const root = d3.hierarchy(data)
        .sum(d => d.value);
    
    // Apply the partition layout to the hierarchy
    partition(root);
    
    // All nodes array for searching
    let allNodes = [];
    root.eachBefore(d => {
        if (d.data.id) {
            allNodes.push(d);
        }
    });
    
    // Draw the visualization
    function drawSunburst(rootNode) {
        // Clear existing visualization
        svg.selectAll("*").remove();
        
        // Create the slices
        const slice = svg.selectAll("path")
            .data(rootNode.descendants().filter(d => d.depth))
            .enter()
            .append("path")
            .attr("d", arc)
            .attr("class", "node")
            .style("fill", d => {
                // Use different color schemes based on the first character of the ID
                if (d.data.id && d.data.id.startsWith('F')) {
                    // Mental disorders - use a blue spectrum
                    return d3.interpolateBlues(0.3 + 0.7 * (d.depth / 5));
                } else {
                    // Other codes
                    return colorScale(d.depth);
                }
            })
            .style("stroke", "#fff")
            .style("stroke-width", "1px")
            .style("opacity", 0.8);
        
        // Add interactivity
        slice.on("mouseover", function(event, d) {
                // Highlight the slice
                d3.select(this)
                    .style("opacity", 1);
                
                // Update tooltip
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                tooltip.html(`
                    <strong>${d.data.id}</strong><br>
                    ${d.data.name}<br>
                    Depth: ${d.depth}
                `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                // Reset the slice
                d3.select(this)
                    .style("opacity", 0.8);
                
                // Hide tooltip
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
            .on("click", function(event, d) {
                updateInfoPanel(d);
                updateBreadcrumbs(d);
                
                // Zoom in if the node has children
                if (d.children && d.children.length > 0) {
                    zoomToNode(d);
                }
            });
        
        // Center text (optional)
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .text(rootNode.data.name || "Root");
    }
    
    // Function to zoom to a specific node
    function zoomToNode(node) {
        // Create a new hierarchy based on the current node
        const newRoot = d3.hierarchy(node.data)
            .sum(d => d.value);
        
        // Apply the partition layout
        partition(newRoot);
        
        // Redraw the sunburst
        drawSunburst(newRoot);
    }
    
    // Function to update the info panel
    function updateInfoPanel(node) {
        const infoPanel = document.getElementById("infoPanel");
        
        // Format the information
        let html = `
            <div class="code-details">
                <div class="code-title">Diagnostic Code:</div>
                <span class="code-value">${node.data.id || "N/A"}</span>
                
                <div class="code-description">
                    <strong>Name:</strong> ${node.data.name || "N/A"}<br>
                    <strong>Level:</strong> ${node.depth}<br>
                </div>
            </div>
        `;
        
        // Add additional information if available
        if (node.data.value) {
            html += `<div><strong>Value:</strong> ${node.data.value}</div>`;
        }
        
        // Add parent information
        if (node.parent && node.parent.data.id) {
            html += `
                <div style="margin-top: 15px;">
                    <strong>Parent Code:</strong> ${node.parent.data.id}<br>
                    <strong>Parent Name:</strong> ${node.parent.data.name || "N/A"}
                </div>
            `;
        }
        
        // Add children information
        if (node.children && node.children.length > 0) {
            html += `
                <div style="margin-top: 15px;">
                    <strong>Sub-categories (${node.children.length}):</strong>
                    <ul style="max-height: 150px; overflow-y: auto;">
                        ${node.children.map(child => 
                            `<li><span class="code-value">${child.data.id}</span> - ${child.data.name}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        } else {
            html += `<div style="margin-top: 15px;"><em>This is a leaf node with no sub-categories.</em></div>`;
        }
        
        infoPanel.innerHTML = html;
    }
    
    // Function to update breadcrumbs
    function updateBreadcrumbs(node) {
        const breadcrumbs = document.getElementById("breadcrumbs");
        
        // Clear existing breadcrumbs
        breadcrumbs.innerHTML = "";
        
        // Build the path back to the root
        const path = [];
        let current = node;
        
        while (current) {
            path.unshift(current);
            current = current.parent;
        }
        
        // Create new breadcrumbs
        path.forEach((node, index) => {
            // Create breadcrumb item
            const item = document.createElement("span");
            item.className = "breadcrumb-item";
            item.textContent = node.data.id || "Root";
            item.setAttribute("data-id", node.data.id || "root");
            
            // Add click handler
            item.addEventListener("click", () => {
                zoomToNode(node);
                updateInfoPanel(node);
                updateBreadcrumbs(node);
            });
            
            // Add to breadcrumbs
            breadcrumbs.appendChild(item);
            
            // Add divider (except for the last item)
            if (index < path.length - 1) {
                const divider = document.createElement("span");
                divider.className = "breadcrumb-divider";
                divider.textContent = ">";
                breadcrumbs.appendChild(divider);
            }
        });
    }
    
    // Search functionality
    document.getElementById("searchButton").addEventListener("click", performSearch);
    document.getElementById("searchInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            performSearch();
        }
    });
    
    function performSearch() {
        const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
        const resultsContainer = document.getElementById("searchResults");
        
        if (!searchTerm) {
            resultsContainer.style.display = "none";
            return;
        }
        
        // Filter nodes based on the search term
        const results = allNodes.filter(node => {
            const id = node.data.id ? node.data.id.toLowerCase() : "";
            const name = node.data.name ? node.data.name.toLowerCase() : "";
            
            return id.includes(searchTerm) || name.includes(searchTerm);
        });
        
        // Display results
        resultsContainer.innerHTML = "";
        resultsContainer.style.display = "block";
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No matching codes found</div>';
            return;
        }
        
        // Sort results (codes with the search term at the beginning come first)
        results.sort((a, b) => {
            const aId = a.data.id ? a.data.id.toLowerCase() : "";
            const bId = b.data.id ? b.data.id.toLowerCase() : "";
            
            // If one starts with the search term and the other doesn't
            if (aId.startsWith(searchTerm) && !bId.startsWith(searchTerm)) return -1;
            if (!aId.startsWith(searchTerm) && bId.startsWith(searchTerm)) return 1;
            
            // Otherwise sort alphabetically
            return aId.localeCompare(bId);
        });
        
        // Limit to top 20 results
        const limitedResults = results.slice(0, 20);
        
        // Create result items
        limitedResults.forEach(node => {
            const resultItem = document.createElement("div");
            resultItem.className = "search-result-item";
            resultItem.innerHTML = `<strong>${node.data.id}</strong> - ${node.data.name}`;
            
            resultItem.addEventListener("click", () => {
                // Navigate to this node
                zoomToNode(findNodeInHierarchy(root, node.data.id));
                updateInfoPanel(node);
                updateBreadcrumbs(node);
                
                // Clear search
                resultsContainer.style.display = "none";
                document.getElementById("searchInput").value = "";
            });
            
            resultsContainer.appendChild(resultItem);
        });
    }
    
    // Helper function to find a node by ID in the hierarchy
    function findNodeInHierarchy(root, id) {
        let found = null;
        
        function search(node) {
            if (node.data.id === id) {
                found = node;
                return;
            }
            
            if (node.children) {
                for (const child of node.children) {
                    search(child);
                    if (found) break;
                }
            }
        }
        
        search(root);
        return found || root;
    }
    
    // Initialize the visualization
    drawSunburst(root);
    </script>
</body>
</html>